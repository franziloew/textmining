---
title: "Whats inside the news?"
author: Franziska Löw
date: December 16, 2017
output: 
  revealjs::revealjs_presentation:
    theme: simple
    highlight: haddock
    center: true
    transition: slide
    css: style.css
    #self_contained: false
    incremental: true
---

```{r include=FALSE}
suppressPackageStartupMessages({
  library(dplyr)       # Data manipulation
  library(stringr)     # String manipulation
  library(lubridate)   # Date and time manipulation
  library(purrr)       # Functional programming
  library(tidyr)       # Reshaping
  library(magrittr)    # Advanced piping
  library(pushoverr)   # Pushover notifications
  library(doMC)        # Parallel Computing
  library(readr)       # Importing data
  library(tibble)      # Better data frames
  library(data.table)
  library(pscl)
  library(boot)
  library(stm)
  library(tm)
  library(readxl)
  
  library(ggplot2)     # Static data visualization
  library(ggpmisc)
  library(RColorBrewer) 
  library(ggrepel)
  library(plotly)
  library(scales)      # Scales
  library(viridis)     # Viridis color scales

  library(tidytext)    # Tidy text mining
  library(stringdist)  # String distances
  library(proxy)       # Distance measures
})

# Theming
quartzFonts(
  Roboto =
    c("Roboto-Light",
      "Roboto-Bold",
      "Roboto-Regular",
      "Roboto-Thin")
)

theme_set(
  theme_bw(base_family = "Roboto", base_size = 10) +
    theme(
      plot.title = element_text(size = 12,
                                margin = margin(0, 0, 4, 0, "pt")),
      plot.subtitle = element_text(size = 12),
      plot.caption = element_text(size = 6, hjust = 0),
      axis.title = element_text(size = 8),
      panel.border = element_blank()
    )
)
col <- brewer.pal(8,"Dark2")
```

## Agenda

1. **Introduction**

2. **Methodology**

3. **Literature Review**

4. **First Results**

5. **Conclusion**

# Introduction
## Online News
<div style="position:relative; width:640px; height:480px; margin:0 auto;">
  <img class="fragment" src="../figs/screenshot-spon.png" style="position:absolute;top:0;left:0;" />
  <img class="fragment" src="../figs/screenshot-focus.png" style="position:absolute;top:0;left:0;" />
  <img class="fragment" src="../figs/screenshot-bild.png" style="position:absolute;top:0;left:0;" />
  <img class="fragment" src="../figs/screenshot-tagesschau.png" style="position:absolute;top:0;left:0;" />
</div>

## Business Model of online News

<img class="fragment" src="../figs/onlinenews-2.png" width="900"/>

---------------------------

### Research Question: 
Does the business model have an effect on the editorial content?

### Methodology: 
  1. Estimate a Structural Topic Model
  2. Use posterior distribution to estimate the effect of document metadata. 

## Data
Online news articles about domestic politics from 01.06.2017 - 22.11.2017

<img class="fragment" src="../figs/timeline.png" width="850"/>

----------------------
```{r eval=FALSE, include=FALSE}
load("../output/models/STM 28 .Rda")

tidy.df <- btw %>%
  unnest_tokens(word, text_cleaned) %>%
  count(word, articleID, sort =TRUE) 

dtm <- tidy.df %>% dplyr::filter(nchar(word)>1) %>%
  cast_dtm(articleID, word, n)
save(stmOut, btw, dtm, tidy.df, file="../output/presentation_files.Rda")
```

```{r message=FALSE, warning=FALSE, include=FALSE}
load("../output/presentation_files.Rda")
table <- inspect(dtm[1:5,1:10])
```

> - Documents (articles) are stored on a "Document-Term-Matrix"
```{r echo=FALSE}
htmlTable::htmlTable(table)
```

  - Documents are seen as "bag of words"
  - Each article has metadata: publisher (news platform) and the day it was published. 
  

- How to find out latent topics in an article?

# Methodology

## Topic Model

<img src="../figs/lda-2.png">
<small>Credits: Christine Doig</small>

## The intuition behind LDA

<img src="../figs/lda-blei.png" width="750"/>

<small>Credits: Blei (2012)</small>

* Model the generation of documents with latent topic structure
    * a topic ~ a distribution over words
    * a document ~ a mixture over topics
    * a word ~ a sample drawn from one topic

    
<aside class="notes">
 - Documents are seen as "bag of words". 
 - Mixed memberhip model: Population of topics stays the same, but distrubution over topics changes for ech document
 - Each document is comming from a mixture model, where the mixture proportions change from document to document but mixture components are fixed a cross all documents.
 - Each document arises as follows: 
    1. chose a distribution over topics (histogram) 
    2. For each word in the document, chose a colored button
    3. look up the distribution over terms associated with that button and draw a word
</aside>

## LDA as a graphical model

<img src="../figs/lda-plate.png" width="800">

> - Nodes a random variables; edges indicate dependence
> - Shaded nodes are observed; unshaded nodes are hidden.
> - Plates indicate replicated variables.

<aside class="notes">
		-Generative Process:
  1. chose Number of topics (e.g. K=100)
  2. Each topic has a $\beta$, which is a distribution over the full vocabulary
  3. For each Document (D) I chose a distribution over topics ($\theta$)
  4. For each word in each document (N) I chose a colored button from $\theta$ 
  5. Chose a word from the corresponding distribution over terms
- Diagram:
    - defines a factorization of the joint probability distribution of hidden and observed random variables.
    - encodes indepence assumptions about the variables (which variables are dependent and conditionally independent) 
    - Connects to algorithm for computing with data: Inference problem: finding the hidden variables given the observations.
	</aside>
  
------------------------
<img src="../figs/lda-plate-2.png" width="800">

- The posterior is: $p(\theta,z,\beta|w) = \frac{p(\theta,\beta,z,w)}{p(w)}$
  
    - **numerator**: joint distribution of all random variables (can be easily computed for any setting of hidden variables.)
    - **denominator**: marginal probability of the observations (probability of seeing the observed corpus under any topic model.)

- From a collection of documents, infer
    - Per-word topic assignment $z_{d,n}$
    - Per-document topic proportions $\theta_d$
    - Per-corpus topic distributions $\beta_k$
    
- Then use posterior expectations to perform the task at hand: information retrieval, document similarity, exploration, and others.

<aside class="notes">
  - the joint distribution defines a posterior. 
  - In theory, it can be computed by summing the joint distribution over every possible instantiation of the hidden topic structure.
  - $p(\theta,z,\beta|w)$ the probability of the hidden structures given the observed words in a document.
  - - That number of possible topic structures, however, is exponentially large; this sum is intractable to compute. As for many modern probabilistic models of interest—and for much of modern Bayesian statistics—we cannot compute the posterior because of the denominator, which is known as the evidence. A central research goal of modern probabilistic modeling is to develop efficient methods for approximating it. Topic modeling algorithms—like the algorithms used to create Figures 1 and 3—are often adaptations of general-purpose methods for approximating the posterior distribution.
  - First uncover the structure (calculate th posterior) - use the discovered distributions to perform task
</aside>

## Research Process

<img class="fragment" src="../figs/research_strategy.png" width="1000"/>

<aside class="notes">
  1. We have knowledge about the world and want to answer a specific question: We know that newspapers are based on different business models. does that have an effect on the topics discussed in the newspaper?
  2. We make assumptions and bring them together with our data to uncover patterns.
  3. We use these patterns (posterior distributions) to predict a variable
</aside>

## Strucutral Topic Model
- We want to use estimates of $\theta_d$ as the dependent variable in an regression on covariates to test whether different types of documents have different content.

- This is contradictory because documents are assumed to be generated by the same statistical process.

- The structural topic model (STM) of Roberts et. al. (2016) explicitly introduces covariates into a topic model, and allows one to estimate the impact of document-level covariates on topic content and prevalence as part of the topic model itself.

## Topic Prevalence vs. Content
- The process for generating individual words is the same as for plain LDA conditional on the $\beta_k$ and $\pi_d$ terms.

- However both objects can depend on potentially different sets of document- level covariates. Each document has:
    1. **Topic Prevalence**: Attributes that affect the likelihood of discussing topic $k$
    2. **Topic Content**: Attributes that affect the likelihood of including term $v$ overall, and of including it within topic $k$
    
- The generation of the $\beta_k$ and $\pi_k$ terms is via multinomial logistic regression, which breaks local conjugacy.

## Model Selection
- There are three parameters we need to make assumptions about: number of topics $K$ and priors $\alpha, \eta$:
  - Priors don’t receive too much attention in literature: 
    - Griffiths & Steyvers (2002) recommend $\eta = 200/V$ and $\alpha = 50/K$. 
    - Smaller values will tend to generate more concentrated distributions. (See also Wallach et.al. (2009)).
  - $K$ is clearer. Two potential goals:
    1. Predict text well. Statistical criteria to select $K$.
    2. Interpretability. General versus specific.

## Approximate Posterior
- Mean field variational methods (Blei et al., 2001, 2003)
- Expectation propagation (Minka and Lafferty, 2002)
- Collapsed Gibbs sampling (Griffiths and Steyvers, 2002)
- Distributed samplung (Newsman et al., 2008; Ahmed et al., 2012)
- Stochastic inference (Hoffman et al., 2010, 2013; Mimno et al., 2012)
- Factorization inference (Arora et al., 2012; Anandkumar et al., 2012)
- Amortized inference (Srivastava and Sutton, 2019)
- ...

<aside class="notes">
  - We cannot obtain exact solutions for our posterior
  - Instead of obtaining a closed-form solution for the posterior distribution, we must approximate it.
</aside>

## Predicitve Distributions

$\beta_{k,v} = \frac{m_{k,v}+\eta}{\sum_{v=1}^V(m_{k,v}+\eta)}$

$\theta_{k,v} = \frac{n_{d,k}+\alpha}{\sum_{k=1}^K(n_{d,k}+\alpha)}$

## Formalizing Interpretability
- Chang et. al. (2009) propose an objective way of determining whether topics are indeed interpretable.
- Two tests:
  1. *Word intrusion*:
      - Form set of words consisting of top five words from topic k + word with low probability in topic k. 
      - Ask subjects to identify inserted word.
  2. *Topic intrusion*: 
      - Show subjects a snippet of a document + top three topics associated to it + randomly drawn other topic. 
      - Ask to identify inserted topic.
      
# Model Results

```{r Extract wtp and dtp, include=FALSE}
load("../output/models/STM 28 .Rda")

# Word-topic probabilities
stmOut %>% tidy("beta") %>% filter(!is.na(topic)) -> posts.wtp
# Document-topic probabilities
stmOut %>% tidy("gamma") -> posts.dtp

# Label Topics
label <- labelTopics(stmOut, n=3)

prob <- as.data.frame(label$prob, stringsAsFactors = F)
frex <- as.data.frame(label$frex, stringsAsFactors = F)
lift <- as.data.frame(label$lift, stringsAsFactors = F)
score <- as.data.frame(label$score, stringsAsFactors = F)

topicLabel <- prob %>% 
  transmute(topic = rownames(.),
            topic_name = paste(prob$V1,prob$V2,prob$V3,score$V1,score$V2,score$V3, sep=","),
            prob = paste(prob$V1,prob$V2,prob$V3, sep=","),
            frex = paste(frex$V1,frex$V2,frex$V3, sep=","),
            lift = paste(lift$V1,lift$V2,lift$V3, sep=","),
            score = paste(score$V1,score$V2,score$V3, sep=",")) 

topicLabel$topic_name <- vapply(lapply(strsplit(topicLabel$topic_name, ","), unique), paste, character(1L), collapse = " ")
rm(prob, frex, lift, score)
```

## Topic Proportions

<img src="../figs/topic_proportion.png" width="600">

## Sample Articles
