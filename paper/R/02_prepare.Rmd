---
title: "Topic Modeling of News"
author: "Franziska Löw"
date: "`r format(Sys.Date())`"
output: github_document
---

```{r, include=FALSE}
# load the packages
libs <- c("tidytext","tidyr","readr","lubridate","tm","stm","RColorBrewer",
          "plyr","dplyr","class","knitr","kableExtra","cldr","data.table",
          "htmlTable","ggplot2","gridExtra","jsonlite","stringr","scales","rjson")
lapply(libs, library, character.only = TRUE)

```

# Load and prepare Dataframe

```{r}
rm(list =ls())

load("../output/news_cleaned.Rda")
```

# Pre-Process Text

```{r}
df %>%
  distinct(text, .keep_all = TRUE) -> df
```


```{r}
pat <- 'Aus unserem Netzwerk[^"]*'
btw %>%
  filter(grepl(pat, text, perl = TRUE)) %>%
  group_by(site) %>%
  tally(sort = TRUE)
```
```{r}
as.data.frame(str_match(btw$text, pat)) ->test
test %>%
  filter(!is.na(test)) %>%
  .[1]
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
clean.text <- function(x)
  {
  # All
  x = gsub("Getty Images", "", x)

  # Bild.de
  x = gsub("Shopübersicht Top Gutscheine", "", x)

  # Handelsblatt.com
  x = gsub("RSS Feed", "", x)
  x = gsub("Deutsche Presse Agentur", "", x)

  # FOCUS.de
  x = gsub("FOCUS Online/Wochit", "", x)
  x = gsub("Vielen Dank! Ihr Kommentar wurde abgeschickt.", "", x)
  x = gsub('Im Interesse unserer User[^"]*', "", x, perl = TRUE)
  x = gsub('Sie haben noch 800[^"]*', "", x, perl = TRUE)
  x = gsub('Erzählen Sie auf FOCUS Online über Ihren Heimatort Teilen Sie Ihren Artikel und Ihr Foto', "", x, perl = TRUE)
  x = gsub("Bericht schreiben", "", x)
  x = gsub("Vielen Dank! Ihr Kommentar wurde abgeschickt.", "", x)
  x = gsub("Hier können Sie selbst Artikel verfassen:","", x)
  x = gsub("Live-Ticker", "", x)
  x = gsub('Aus unserem Netzwerk[^"]*', "", x, perl = TRUE)

  # Spiegel.de
  x = gsub("7 mal 17", "", x)
  x = gsub("Zur Startseite Diesen Artikel... Drucken Feedback Nutzungsrechte", "", x)
  x = gsub('Liebe Leserin, lieber Leser,\num diesen[^"]*', "", x)
  x = gsub('Liebe Leserin, lieber Leser, um diesen[^"]*', "", x)
  x = gsub('ejf[^"]*', "", x)
  x = gsub('tjf[^"]*', "", x)

  # Zeit.de
  x = gsub("Inhalt Seite", "", x)
  
  # Tagesschau
  x = gsub('Hinweis.+?(?=(einfügen))', "", x, perl = TRUE)
  
  return(x)
}

# apply function to dataframe
df$text_cleaned <- clean.text(df$text)
```

```{r}
df$text_cleaned <- gsub("[[:punct:]]", " ", df$text_cleaned)
df$text_cleaned <- gsub("[[:cntrl:]]", " ", df$text_cleaned)
df$text_cleaned <- gsub("[[:digit:]]", " ", df$text_cleaned)
df$text_cleaned <- gsub("^[[:space:]]+", " ", df$text_cleaned)
df$text_cleaned <- gsub("[[:space:]]+$", " ", df$text_cleaned)
df$text_cleaned <- tolower(df$text_cleaned)
```

```{r}
# Save file
save(df, file="../output/news_cleaned2.Rda")
```

## Remove Stopwords
```{r}
df$text_cleaned<- removeWords(df$text_cleaned, stopwords("german"))
```

### Remove customized stopwords
```{r}
mystopwords <- c("focus","online","spiegel", "stern", "handelsblatt", "de", "bild","bildplus", "zeit", "ersten", "tagesschau", "wdr", "ndr", "ich","sie","passwort","kommentar","wurde","ihr","der","im","artikel","mehr","ihren","foto","e", "uhr","videolänge","dass","mindestens","das","mail","die","schon","neuer abschnitt", "login", "loggen", "inaktiv", "nwmi", "nwnoa", "polizei","beim","dpa","video","quelle","afp","witters","fotogalerie", "registrierter","als","spiegel","vielen","in","es","bitte","dank","unserer","nutzer","sei","beitrag","user","seit","zeichen", "datenschutzerklärung","premium","nutzungsbedingungen","nutzungsrechte","pflichtfelder","registrierung","anzeige","großbuchstaben","sonderzeichen","html","seitennavigation","fullscreen","statista","club","sagte","borenda","spreepicture","shopübersicht")

mystopwords <- distinct(as.data.frame(mystopwords))

df$text_cleaned<- removeWords(df$text_cleaned, mystopwords$mystopwords)
```

```{r}
save(df, file="../output/news_cleaned2.Rda")
```

## Generate new variables 
```{r}
df$video <- ifelse(grepl("video", df$title, ignore.case = TRUE),1,0)
df$date <- as.Date(df$date)
```

## Reduce Dataframe
```{r}
df %>%
  filter(!site %in% c("ndr.de","wdr.de", "swr.de","tagessschau.de")) %>%
  filter(grepl("bundestagswahl", text, ignore.case = TRUE)) -> btw

btw$ArticleID <- rownames(btw)
```

```{r}
save(df, btw, file="../output/news_btw.Rda")
```