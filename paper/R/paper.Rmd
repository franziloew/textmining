---
title: "Regression"
subtitle: ""
author: "Franziska LÃ¶w"
date: ""
output: 
  html_document:
    toc: true
    toc_float: true
    theme: "lumen"
    highlight: "tango"
    code_folding: show
    self_contained: true
---

```{r}
suppressPackageStartupMessages({
  library(dplyr)       # Data manipulation
  library(stringr)     # String manipulation
  library(lubridate)   # Date and time manipulation
  library(purrr)       # Functional programming
  library(tidyr)       # Reshaping
  library(magrittr)    # Advanced piping
  library(pushoverr)   # Pushover notifications
  library(doMC)        # Parallel Computing
  library(readr)       # Importing data
  library(tibble)      # Better data frames
  library(data.table)
  library(pscl)
  library(boot)
  library(stm)
  library(readxl)
  
  library(ggplot2)     # Static data visualization
  library(ggpmisc)
  library(ggiraph)
  library(RColorBrewer) 
  library(ggrepel)
  library(htmlwidgets)
  library(plotly)
  library(scales)      # Scales
  library(viridis)     # Viridis color scales

  library(tidytext)    # Tidy text mining
  library(stringdist)  # String distances
  library(proxy)       # Distance measures
})

# Theming
quartzFonts(
  Roboto =
    c("Roboto-Light",
      "Roboto-Bold",
      "Roboto-Regular",
      "Roboto-Thin")
)

theme_set(
  theme_bw(base_family = "Roboto", base_size = 8) +
    theme(
      plot.title = element_text(face = "bold", size = 14,
                                margin = margin(0, 0, 4, 0, "pt")),
      plot.subtitle = element_text(size = 12),
      plot.caption = element_text(size = 6, hjust = 0),
      axis.title = element_text(size = 10),
      panel.border = element_blank()
    )
)

rm(list=ls())
col <- brewer.pal(6,"Dark2")
```

# Load Data
```{r caching, echo = FALSE}
#load("../output/models/STM 80 .Rda")
load("../output/btw_combined.Rda")
```

### Distribution of articles
```{r message=FALSE, warning=FALSE}
ggsave({
  btw %>%
  ggplot(aes(site)) +
  geom_bar(fill=col, alpha= .8) +
  labs(x="", y="Count") +
  theme(
      legend.position   = "none",
      plot.background   = element_rect("#fafafa", "#fafafa"),
      plot.title        = element_text(size = 18),
      plot.subtitle     = element_text(size = 8),
      plot.caption      = element_text(size = 7),
      panel.background  = element_rect("#fafafa"),
      axis.title.x      = element_blank(),
      axis.text.y       = element_text(size = 8)
    )
  
},
filename = "../figs/bar.png", device = "png", 
width = 6, height = 4,
        dpi = 600)
```

```{r message=FALSE, warning=FALSE}
ggsave({
  btw %>%
  group_by(date, site) %>%
  dplyr::summarise(obs = n()) %>%
  ggplot(aes(date, obs, color = site)) +
  geom_line() +
  #geom_vline(aes(xintercept=as.Date("2017-09-24")),
  #           linetype = 2, color="grey40") +
  #geom_vline(aes(xintercept=as.Date("2017-11-20")),
  #               linetype = 2, color="grey40") +
  scale_color_manual(values = col) +
  labs(x="", y="Count",color="") +
  scale_x_date(breaks = date_breaks("1 month"), labels=date_format("%B", tz="CET")) +
  theme(
      #legend.position   = "none",
      plot.background   = element_rect("#fafafa", "#fafafa"),
      plot.title        = element_text(size = 18),
      plot.subtitle     = element_text(size = 8),
      plot.caption      = element_text(size = 7),
      #panel.grid        = element_blank(),
      panel.background  = element_rect("#fafafa"),
      axis.title.x      = element_blank(),
      axis.text.y       = element_text(size = 8)
    )
},
filename = "../figs/timeline.png", device = "png",width = 7, height = 4,
dpi = 600
)

```

# Model Results
```{r Extract wtp and dtp}
# Word-topic probabilities
stmOut %>% tidy("beta") %>% filter(!is.na(topic)) -> posts.wtp
# Document-topic probabilities
stmOut %>% tidy("gamma") -> posts.dtp
```

## Topic Labeling
```{r Label Topics}
label <- labelTopics(stmOut, n=5)

# topicLabel <- as.data.frame(label$topics)
# 
# topicLabel <- topicLabel %>% 
#   transmute(topic = rownames(.),
#              topic_name = paste(V1,V2,V3,V4,V5, sep=","))

prob <- as.data.frame(label$prob, stringsAsFactors = F)
frex <- as.data.frame(label$frex, stringsAsFactors = F)
lift <- as.data.frame(label$lift, stringsAsFactors = F)
score <- as.data.frame(label$score, stringsAsFactors = F)

topicLabel <- prob %>%
  transmute(topic = rownames(.),
            topic_name = paste(prob$V1,prob$V2,prob$V3,score$V1,score$V2,score$V3, sep=","),
            prob = paste(prob$V1,prob$V2,prob$V3, sep=","),
            frex = paste(frex$V1,frex$V2,frex$V3, sep=","),
            lift = paste(lift$V1,lift$V2,lift$V3, sep=","),
            score = paste(score$V1,score$V2,score$V3, sep=","))

topicLabel$topic_name <- vapply(lapply(strsplit(topicLabel$topic_name, ","), unique), paste, character(1L), collapse = " ")
rm(prob, frex, lift, score)
```

```{r}
labelTopics(stmOut, 57, n=15)
```

```{r}
top_topics <-
  posts.dtp %>% 
  group_by(document) %>%
  mutate(therank = rank(-gamma, ties.method = "random")) %>%
  filter(therank %in% 1) %>%
  select(- therank)

# Add Topic to origian DF
btw$articleID = as.numeric(rownames(btw))

btw %>%
  mutate(document = articleID) %>%
  inner_join(.,top_topics, by="document") %>%
  ## Combine with Topic label
  left_join(., topicLabel %>%
              select(topic_name, topic) %>%
              mutate(topic = as.numeric(topic)), by="topic") -> btw
```

## Topic Proportion
```{r fig.height=12, fig.width=9}
#library(stm)
#png("../figs/topic_proportion.png")
plot(stmOut, type = "summary", xlim = c(0,.5), n = 5, 
     custom.labels = topicLabel$topic_name, 
     family = "Roboto", main = "", text.cex = 0.8)
#dev.off()
```

```{r}
btw %>% filter(grepl("zagatta", text_cleaned)) %>% select(url)
```


```{r}
keeps <- c(7,27,46,24,18,16,49,9,38,57,59,36,13)
```

## Sample Articles

```{r Document classification}
set.seed(9272)
posts_classification.sdt <-
  posts.dtp %>% 
  filter(topic %in% keeps) %>%
  group_by(articleID = document) %>% 
  summarise(topic = min(topic[gamma == max(gamma)]), gamma = max(gamma)) %>% 
  ungroup() %>%
  inner_join(btw %>% filter(topic %in% keeps) %>%
               select(title, title_text, articleID, topic_name, site),
              by = "articleID") %>%
  mutate(topic_title = 
           paste0("Topic ", formatC(topic, flag = "0", width = 2), 
                  " - ", topic_name)) %>%
  group_by(topic_name, site) %>% 
  top_n(50, gamma) %>%
  sample_n(3) %>%
  mutate(row = row_number()) %>% 
  ungroup() 
```

```{r}
posts_classification.sdt %>%
  select(site,topic_title,title) %>%
  htmlTable::htmlTable(align="l")
```


## Estimating the Effect of Covariates

### Difference in topic prevalence
The estimateEffect() function explores how prevalence of topics varies across documents according to document covariates (metadata). First, users must specify the variable that they wish to use for calculating an effect. If there are multiple variables specified in estimateEffect(), then all other variables are held at their sample median. These parameters include the expected proportion of a document that belongs to a topic as a function of a covariate, or a first difference type estimate, where topic prevalence for a particular topic is contrasted for two groups.

```{r}
prep <- estimateEffect(keeps ~site + s(week),
                       stmOut, meta=out$meta, uncertainty = "Global")
```

```{r}
summary(prep)
```

Expected difference in topic probability by news source (with 95% Confidence Intervals). 
parameter "covariate": String of the name of the main covariate of interest. Must be enclosed in quotes. All other covariates within the formula specified in estimateEffect will be kept at their median.
```{r}
for (i in keeps){
  
  png(paste0("../figs/estimate_effect",i,".png"))
  plot(prep, "site", method = "pointestimate", topics = i,
       labeltype = "custom", custom.labels = unique(prep$data$site),
       ylab = "", xlab = "Mean topic proportion in corpus",
       main = paste0("Topic ",i,": ",topicLabel$topic_name[i]),
       xlim = c(-.05,0.2))
  dev.off()
}

#plot(prep, "site", method = "pointestimate", topics = keeps[1])
```

```{r}
for (i in keeps){
  plot(prep, "week", method = "continuous", topics = i,
       printlegend = F,
       ylab = "", xlab = "Mean topic proportion in corpus",
       main = paste0("Topic ",i,": ",topicLabel$topic_name[i]))
}

```

```{r}
p<- posts.dtp %>%
  left_join(., btw %>% select(document, topic_name,
                              site, week),
            by="document")  %>%
  group_by(site, topic, topic_name, week) %>%
  summarize(gamma_mean = mean(gamma)) %>%
  #filter(month!=5) %>%
  ggplot(aes(x=week, y=gamma_mean, fill=factor(topic), text=topic_name)) +
  geom_col() +
  facet_wrap(~site) +
  #facet_grid(~site) +
  theme(legend.position = "none") +
  xlab("Proportion")

ggplotly(p)
```

What is the distribution of the gamma value?
```{r}
ggsave(plot={
  btw %>%
    filter(topic %in% keeps) %>%
  ggplot(aes(gamma)) +
  geom_density(fill="blue",alpha=.5,color="blue") 
},
filename = "../figs/gamma_dist.png",
       width = 8, height = 6, device = "png", dpi=600)
```

filter documents with low posterior
```{r}
btw.reg <- btw %>%
  filter(topic %in% keeps) %>%
  filter(gamma >= 0.5) %>%
  mutate(allocation = 1)
```

## Topic Timeline
```{r Data for topic trends chart, message=FALSE, warning=FALSE}
set.seed(7292)
btw.reg %>% 
  mutate(date = as.POSIXct(date),
         allocation = 1) %>%
  mutate(post_period = 
           date %>% with_tz("Europe/Paris") %>% 
           floor_date("week")) %>%
  # Summarise into tidy dataframe
  group_by(post_period, topic, topic_name) %>% dplyr::summarise(articles = sum(allocation)) %>%
  # Mark peaks 
  group_by(topic_name) %>% dplyr::mutate(peak = ifelse(articles==max(articles),1,0)) -> chart_topic_trends.dt
```

```{r message=FALSE, warning=FALSE}
ggsave(
  plot = {
    ggplot(chart_topic_trends.dt, 
       aes(post_period, articles, color=topic_name)) +
  geom_line() +
  scale_color_manual(
            values = rainbow(20) %>% 
              adjustcolor(red.f = 0.6, green.f = 0.6, blue.f = 0.6)
          ) +
  geom_text_repel(data=subset(chart_topic_trends.dt,peak==1),
            aes(post_period,articles,label=paste(topic,topic_name,sep=":")),
            size=2.8) +
      geom_vline(aes(xintercept=as.POSIXct("2017-09-23")),
                 linetype = 2, color="grey20") +
      geom_vline(aes(xintercept=as.POSIXct("2017-11-19")),
                 linetype = 2, color="grey20") +
  ylim(c(0,200)) +
    theme(
      legend.position   = "none",
      #plot.background   = element_rect("#fafafa", "#fafafa"),
      plot.title        = element_text(size = 18),
      plot.subtitle     = element_text(size = 8),
      plot.caption      = element_text(size = 7),
      panel.grid        = element_blank(),
      #panel.background  = element_rect("#fafafa"),
      axis.title.x      = element_blank(),
      axis.text.y       = element_text(size = 8)
    )
  },
  device = "png",
  filename = "../figs/topic-timeline.png",
  dpi = 600, height = 5, width = 8
)
```


### Topic Distribution by News Page

A common accusation leveled against traditional news media is the amount of bias in reporting various topics. We try to explore the topic distribution of news articles.

```{r Data for topic distribution chart}

set.seed(7292)
btw.reg %>% 
    mutate(document = articleID) %>%
  group_by(site, topic, topic_name) %>%
  summarise(
    articles = sum(allocation),
    sample_articles = 
      paste0(
        "<li>", sample(title, pmin(3, length(document))), "</li>",
        collapse = "<br>"
      )
  ) %>%
  ungroup() %>%
  group_by(site) %>% 
  mutate(perc_articles = articles/sum(articles)) %>% 
  ungroup() %>%
  mutate(
    tooltip_text = 
      paste0(
        "<b>", comma(round(articles, 0)), " (", percent(perc_articles), 
        ") </b> of articles from <b>", site, 
        "</b> fall under <b>", "Topic",topic,": ", topic_name, "</b><br><br>Sample Articles:<br><ul>",
        sample_articles, "</ul>"
      ) %>% str_replace_all("'", "")
  ) ->
  news_page_distribution.dt
```

```{r Topic distribution chart, eval = TRUE}
{
  news_page_distribution.dt %>% 
    ggplot(aes(x = site, y = perc_articles, fill = topic_name)) +
    geom_bar_interactive(
      aes(tooltip = tooltip_text),
      position = position_stack(), 
      stat = "identity", color = "darkgray"
    ) +
    scale_y_continuous(
      name = "Percent of Articles", 
      labels = percent,
      expand = c(0, 0)
    ) +
    theme(
      legend.position = "none",
      axis.title.y = element_blank(),
      legend.background = element_rect("#fafafa"),
      plot.background   = element_rect("#fafafa", "#fafafa"),
      plot.subtitle     = element_text(size = 8),
      plot.caption      = element_text(size = 7),
      plot.title        = element_text(size = 18)
    ) +
    coord_flip() +
    scale_fill_viridis(discrete = TRUE) +
    labs(
      title = ""
    )
} %>% 
  ggiraph(
    ggobj = .,
    width_svg = 12,
    height_svg = 8,
    width = 1,
    tooltip_extra_css = "
    font-family: Roboto; 
    background-color: #000; 
    color: #fff; font-size: 10px;
    padding: 5px;"
  ) -> chart_topic_distribution.wdgt

saveWidget(
  widget = chart_topic_distribution.wdgt,
  file = "../figs/04-topic-distribution-pages.html",
  selfcontained = FALSE,
  libdir = "../figs/js",
  background = "#fafafa"
)

chart_topic_distribution.wdgt

```


## Sentiment analysis
```{r}
library(sentimentr)
```

```{r}
# Load dictionaries (from: http://wortschatz.uni-leipzig.de/de/download)
neg_df <- read_tsv("dict/SentiWS_v1.8c_Negative.txt", col_names = FALSE)
pos_df <- read_tsv("dict/SentiWS_v1.8c_Positive.txt", col_names = FALSE)

sentiment_df <- bind_rows(neg_df,pos_df)
names(sentiment_df) <- c("Wort_POS", "polarity", "Inflektionen")

sentiment_df %>% 
  mutate(words = str_sub(Wort_POS, 1, regexpr("\\|", .$Wort_POS)-1),
         words = tolower(words)
         #POS = str_sub(Wort_POS, start = regexpr("\\|", .$Wort_POS)+1)
         ) %>%
  select(words, polarity) -> sentiment_df

sentiment_df <- rbind(sentiment_df, c("nicht",-0.8))

sentiment_df %>% mutate(polarity = as.numeric(polarity)) %>%
  as_key() -> sentiment_df
```

```{r}
btw.reg %>% 
  mutate(text_split = get_sentences(text)) %$%
  sentiment(text_split,
               polarity_dt = sentiment_df) -> btw_sentiment

btw_sentiment_doclevel <- btw_sentiment %>%
  group_by(element_id) %>%
  summarize(sentiment = mean(sentiment)) 

btw.reg <- left_join(btw.reg, btw_sentiment_doclevel %>%
                       mutate(document = element_id) %>%
                       select(document, sentiment),
                      by="document")
btw.reg %>%
  group_by(site) %>%
  mutate(ave_sentiment = mean(sentiment, na.rm = T)) -> plot_btw
```

```{r}
p1 <- plot_btw %>%
  ggplot(aes(sentiment, factor(site), color=topic_name, 
             text=paste(document,": ",title))) +
  geom_point(alpha=.5, shape=1) +
  xlim(c(-0.25,0.1)) +
  facet_wrap(~topic_name) +
  labs(y="") +
  theme(legend.position = "none")

ggplotly(p1)
```


```{r}
btw.reg %>% 
  filter(document==4) %>%
  mutate(text_split = get_sentences(text)) %$%
  sentiment_by(text_split,
               polarity_dt = sentiment_df) %>%
  sentimentr::highlight()
```

### Radar
```{r}
require(ggiraphExtra)
```

```{r}
btw.reg %>%
  group_by(site, topic_name) %>%
  summarize(sentiment = mean(sentiment, na.rm = T)) %>%
  spread(site, sentiment) %>%
  ungroup() %>%
  mutate(topic=factor(topic_name)) -> radar
```

```{r}
ggsave(plot={
  ggRadar(radar, aes(color=topic), rescale = FALSE,
        legend.position = "none") +
  facet_wrap(~topic, ncol = 4)
},
file="../figs/radar.png",
dpi=600,
height = 7,
width = 9
)
```


